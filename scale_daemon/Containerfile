# STAGE 1: Builder
FROM python:3.12-alpine AS builder

WORKDIR /app

# Copy project definition and requirements files
COPY pyproject.toml requirements.txt ./

# Create virtual environment and install dependencies
RUN python -m venv .venv \
    && .venv/bin/pip install --upgrade pip setuptools wheel \
    && .venv/bin/pip install -r requirements.txt

# Copy the source code
COPY src/ ./src/

# Install the package in development mode
RUN .venv/bin/pip install -e .

# STAGE 2: Tester
FROM builder AS tester
WORKDIR /app

# Copy dev requirements and install them
COPY requirements-dev.txt ./
RUN .venv/bin/pip install -r requirements-dev.txt

# Copy the tests
COPY tests/ ./tests/

# Set PYTHONPATH for tests to find modules
ENV PYTHONPATH="/app/src"

# Set default command to run tests
CMD [".venv/bin/pytest", "tests/"]

# STAGE 3: Final image (renumber from STAGE 2)
FROM python:3.12-alpine AS final

WORKDIR /app

# Create a non-root user and group
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# Copy the virtual environment from the builder stage
COPY --from=builder /app/.venv ./.venv

# Copy the source code from the builder stage
COPY --from=builder /app/src/ ./src/

# Set environment variables for the virtual environment and PYTHONPATH
ENV PATH="/app/.venv/bin:${PATH}"
ENV PYTHONPATH="/app/src"

# Ensure all files are owned by the appuser
RUN chown -R appuser:appgroup /app

# Switch to the non-root user
USER appuser

# Set the default command to run the application
CMD ["python", "-m", "scale_daemon.main"]

# OCI Labels
LABEL org.opencontainers.image.title="Scale Daemon"
LABEL org.opencontainers.image.description="Daemon to read scale data and publish via MQTT."
LABEL org.opencontainers.image.authors="Bernardo Donadio <bernardo@donadio.solutions>"
LABEL org.opencontainers.image.url="https://github.com/donadiosolutions/scale-printer-mqtt"
LABEL org.opencontainers.image.source="https://github.com/donadiosolutions/scale-printer-mqtt"
LABEL org.opencontainers.image.licenses="MIT"
LABEL org.opencontainers.image.vendor="Donadio Solutions"
# LABEL org.opencontainers.image.created="YYYY-MM-DDTHH:MM:SSZ" # Note: This should be set dynamically during the build process
